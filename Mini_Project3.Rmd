---
title: "Mini_Project3"
author: "Nichole, Rowan, Yuqing "
date: "11/13/2017"
output: html_document
---
In this miniproject, we chose to answer Professor Keller's query about the prevalence of original movies in Hollywood in comparison to sequels: reboots, remakes, and adaptations. We chose to group these together, since they all involve the continuation of story, whether it be through the same plot, characters, or world. Through analyzing the IMDb dataset, we hoped to answer the questions of if more sequels were being made today than in the past, if those sequels are made more rapidly today than in the past, and if the rapidity of a sequel's release was related to its genre. 
```{r, message=FALSE}
library(mdsr)
library(RMySQL)
library(dplyr)
db <- dbConnect_scidb(dbname = "imdb")
big_data<- db%>% 
  dbGetQuery("SELECT ml.movie_id, ml.linked_movie_id, ml.link_type_id, t.title AS movie_title, t2.title AS linked_movie_title, t.production_year AS original_year, t2.production_year AS sequels_year, t2.production_year - t.production_year AS year_difference, mi2.info AS genre
FROM movie_link ml
JOIN title t ON ml.movie_id = t.id
JOIN title t2 ON ml.linked_movie_id = t2.id
JOIN movie_info mi On t.id = mi.movie_id
JOIN movie_info mi2 On t.id = mi2.movie_id
JOIN movie_info mi3 On t.id = mi3.movie_id
WHERE ml.link_type_id =2 
AND mi.info_type_id = 8
AND mi.info = 'USA'
AND mi2.info_type_id = 3
AND mi2.info IN ('Comedy', 'Horror', 'Romance')
AND mi3.info_type_id = 1
AND mi3.info > 60
AND t.kind_id = 1
AND t2.kind_id = 1;")

  
#if linked_movie_id seem repetitive, it is because the the movie belongs to different genres

#using "mi.info_type_id = 8" then filter "info='USA'"is index, saving time of calculation
#we also joined movie_info table 3 times, in order to figure out genre(info IN ('Comedy', 'Horror', 'Romance'), filter short movies which lenth is under 60 min, and limit movies to those which are made in U.S.; in such a way we can make sure those movies we have are Hollywood movies
#besides, using  ml.link_type_id =2 we made sure all movies shows are follow up movies of their "related movies", which is the easiest way of tell which one is sequels and which is original movies. 

d1<- big_data %>%
  group_by(sequels_year) %>%
  summarize(total = n())
d2 <- big_data %>%
  group_by(original_year)%>%
  summarize(total = n())
d3 <- d1%>%
  full_join(d2, by = c("sequels_year" = "original_year"))
#x: sequels y:original
d4<- d3%>%
  mutate(decade = 10 * floor(sequels_year / 10)) %>%
  group_by(decade)%>%
  summarize(sequels = sum(total.x),
          original = sum(total.y))
d4
d5 <-d4%>%
  gather(key="movie_type",value = "amount",-decade)
d5
```
```

```{r, message=FALSE}
#deal with data for percentafe bar graph
d_percentage<- d4 %>%
  mutate(total = sequels+original,
    sequels_percentage = sequels*100/total, 
        original_percentage = original*100/total) %>%
  select(sequels_percentage, original_percentage, decade, total) %>% 
  tidyr::gather(key = "type_of_movies", value = "percentage", -decade, -total)
d_percentage
```

```{r,message=FALSE,warning=FALSE}
# Bar graph (total)
library(tidyverse)
ggplot(d5, aes(factor(decade), amount, fill = movie_type)) + 
  geom_bar(stat="identity", position = "dodge",width=.55) 
```

```{r, message = FALSE}
library(ggplot2)
library(ggthemes)
library(plyr)
library(scales)
library(tidyverse)
p1 <- ggplot() + 
geom_bar(aes(y = floor(percentage), x = decade, fill = type_of_movies), data =  d_percentage, stat="identity") + 
geom_text(data=d_percentage, aes(x = decade, y = floor(percentage), label = paste0(floor(percentage),"%")), size=4) 

```

```{r, warning = FALSE}

#create a stacked bar plots
#P.S. the data of 1990 is missing 

d_percentage <- ddply(d_percentage, .(decade),
                     transform, pos = cumsum(percentage) - (0.5 * percentage))
p3 <- ggplot() + geom_bar(aes(y = floor(percentage), x = decade, fill = type_of_movies), data = d_percentage, stat="identity") + 
geom_text(data=d_percentage, aes(x = decade, y = pos, label = paste0(floor(percentage),"%")), size=4) + 
theme(legend.position="bottom", legend.direction="horizontal",
                   legend.title = element_blank()) + 
                   scale_x_continuous(breaks=seq(1890,2010,10))
p3
#move the lable into the center of each bar
```

```{r, message = FALSE}
library(ggplot2)
require(scales)

y1 <- big_data %>%
    group_by(original_year) %>%
   filter(original_year == 1980)
y1

ggplot(big_data, aes(x=original_year, y = year_difference))+
geom_smooth()+
annotate("point", x = 1981, y = 10, color = "red", size = 2) +

facet_wrap(~genre)
# In 1981, a serious economic crisis there was a serious econ crisis. That was when comedy and horror movies went down but when romance movies getting more popular. It is possible that when getting through an econ crisis, people may face unemployment and hard to experience romantic love, thus would more likely to watch romantic movies as a comfort. 
```
